
<!-- Licensed under a BSD license. See license.html for license -->
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="jquery.mousewheel.min.js"></script>
<script src="sprintf.min.js"></script>

<script>
//DATA_ROOT = "https://s3.amazonaws.com/torres-viewer-data"
//DATA_ROOT = "http://localhost/pyramid/breast/pyramid/HnE"
DATA_ROOT = "http://107.170.14.203/breast/pyramid/HnE"

function loadHighRes(e) {
  $('img', e).attr('src', DATA_ROOT+sprintf("/zoom%1d/slice_%04d/tile_x%04d_y%04d.80.jpg", 
    $('.container').data('zoom'), $('.container').data('slice'), e.data('x'), e.data('y')));
}

function buildTiles() {
  console.log('Adding tiles');

  for (x=0; x<8; x++) {
    for (y=0; y<8; y++) {
      tile = $('<div class="tile"><img src=""/></div>');
      tile.data('x', x);
      tile.data('y', y);
      tile.addClass('hidden');
      $('.container').append(tile);
    }
  }

  $('.tile').each( function () {
    $(this).css('left', $(this).data('x')*256);
    $(this).css('top', $(this).data('y')*256);
    $('img', this).attr('src', sprintf(DATA_ROOT+"/zoom%1d/slice_%04d/tile_x%04d_y%04d.20.jpg", 
      $('.container').data('zoom'), $('.container').data('slice'), $(this).data('x'), $(this).data('y')));
  });
}

function updateVisibleTiles() {
  $('.tile').each( function () {
    x = parseInt($(this).css('left'));
    y = parseInt($(this).css('top'));
    console.log(y<1024 && x<1024);
    if (x < 1024 && y < 1024) {
      $(this).removeClass('hidden');
    }
  });
}

$(document).ready(function() {
  buildTiles();

  updateVisibleTiles();

  $('.container').mousewheel(function(event) {
    var delta = event.deltaY;
    if (delta > 1) { delta = 1; }
    if (delta < -1) { delta = -1; }
    var i = $(this).data('slice')+delta;
    if (i<0) { i=0; }
    if (i>160) { i=160; }
    $(this).data('slice', i);
    $('.tile').each( function () {
      $(this).css('left', $(this).data('x')*256);
      $(this).css('top', $(this).data('y')*256);
      $('img', this).attr('src', sprintf(DATA_ROOT+"/zoom%1d/slice_%04d/tile_x%04d_y%04d.20.jpg", 
        $('.container').data('zoom'), $('.container').data('slice'), $(this).data('x'), $(this).data('y')));
      $('img', this).attr('onload', 'loadHighRes($(this).parent());');      
    });    
    //console.log(event.deltaX, event.deltaY, event.deltaFactor);
    $('#info #slice').text($('.container').data('slice'));
    event.preventDefault();
  });
});
</script>

<style>
.viewer {
  border-color: black;
  border-width: 2pt;
  border-style: solid;
}

.hidden {
  display: none;
}

.container {
  position:absolute;
   margin-left: auto;
   margin-right: auto;
   width: 1060px;
  left: 100px;
  top: 100px;
}
.tile {
  position: absolute;
  top: 0px;
  left: 0px;
}
</style>

</head>

<body>
<div class="viewer">
<div class="container" data-slice=90 data-zoom=0>
</div>
</div>
<div id="info">
  <h2 id="slice">10</h2>
  <h2 id="zoom">0</h2>
</div>
</body>
</html>


