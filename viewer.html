<html>
<head>
  <script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
  <link rel="stylesheet" href="//code.jquery.com/ui/1.11.0/themes/smoothness/jquery-ui.css">
  <script src="//code.jquery.com/ui/1.11.0/jquery-ui.js"></script>
  <script src="assets/jquery.mousewheel.min.js"></script>
  <script src="assets/sprintf.min.js"></script>
  <script src="http://cdn.binaryjs.com/0/binary.js"></script>
  <script>
    // Connect to Binary.js server
    var client = new BinaryClient('ws://107.170.14.203:9000');
    var tiles_loading = 0;
    var highResLoaded = false;
    //var streams = {};

    function loadImage(target, src) {
      var stream = client.createStream({'action':'send', 'path':src});
      tiles_loading += 1;
      /*var target_id = target.attr('id');
      if (streams.hasOwnProperty(target_id)) {
        streams[target_id].end();
        delete streams[target_id];        
      }
      streams[target_id] = stream;
      */// Buffer for parts
      var parts = [];
      // Got new data
      stream.on('data', function(data){
        parts.push(data);
      });
      stream.on('end', function(){
        // Display new data in browser!
        $('img', target).attr('src', (window.URL || window.webkitURL).createObjectURL(new Blob(parts)));
        tiles_loading -= 1;
        if (tiles_loading == 0 && !highResLoaded) {
          loadHighresTileImages();
        }
        //delete streams[target_id];
      });
    }

    function buildTiles() {
      $('.tile').remove();

      for (x=0; x<8; x++) {
        for (y=0; y<8; y++) {
          tile = $('<div class="tile"><img src=""/></div>');
          tile.data('x', x);
          tile.data('y', y);
          tile.attr('id', 'tile_'+x+'_'+y)
          tile.addClass('hidden');
          $('#container').append(tile);
        }
      }

      $('.tile').each( function () {
        $(this).css('left', $(this).data('x')*256);
        $(this).css('top', $(this).data('y')*256);
      });

    for (i=168; i>=0; i--) {
      tile = $('<div class="layericon"><img src="../assets/icon_layer.svg"/></div>');
      tile.attr('id', 'layericon'+i);
      tile.css('top', 100+4*i);
      $('#info').append(tile);      
    }

      updateTileImages();
    }

    function updateVisibleTiles() {
      var x0 = parseInt($('#container').css('left'));
      var y0 = parseInt($('#container').css('top'));
      $('.tile').each( function () {
        var x = x0 + parseInt($(this).css('left'));
        var y = y0 + parseInt($(this).css('top'));
        //console.log(y<1024 && x<1024);
        if (x > 0-256*1.5 && y > 0-256*1.5 && x < 1024+256*0.5 && y < 1024+256*0.5) {
//          console.log('visible');
          $(this).removeClass('hidden');
          if ($('img', this).attr('src') == '') {
            loadImage($(this), sprintf("/zoom%1d/slice_%04d/tile_x%04d_y%04d.20.jpg", 
            $('#container').data('zoom'), $('#container').data('slice'), $(this).data('x'), $(this).data('y')));
          }
        }
        else {
//          console.log('hidden');
          $(this).addClass('hidden');
          $('img', this).attr('src', '');
        }
      });
    }

    function dragUpdate(event, ui) {
      updateVisibleTiles();
    }

    function updateTileImages() {
      updateVisibleTiles();
      highResLoaded = false;
      $('.tile:not(.hidden)').each( function () {
        loadImage($(this), sprintf("/zoom%1d/slice_%04d/tile_x%04d_y%04d.20.jpg", 
          $('#container').data('zoom'), $('#container').data('slice'), $(this).data('x'), $(this).data('y')));
      });
    }

    function loadHighresTileImages() {
      updateVisibleTiles();
      highResLoaded = true;
      $('.tile:not(.hidden)').each( function () {
        loadImage($(this), sprintf("/zoom%1d/slice_%04d/tile_x%04d_y%04d.80.jpg", 
          $('#container').data('zoom'), $('#container').data('slice'), $(this).data('x'), $(this).data('y')));
      });
    }

    function activateControls() {
      $('#container').mousewheel(function(event) {

        if (tiles_loading > 0) return;
        var delta = event.deltaY;
        console.log(delta);
        if (delta > 1) { delta = 1; }
        if (delta < -1) { delta = -1; }
        var i = $(this).data('slice')+delta;
        if (i<0) { i=0; }
        if (i>168) { i=168; }
        $(this).data('slice', i);
        updateTileImages();
        //console.log(event.deltaX, event.deltaY, event.deltaFactor);
        $('#info #slice').text($('#container').data('slice'));

        $('.layericon,.active img').attr('src', "../assets/icon_layer.svg");
        $('.layericon,.active').removeClass('active');
        $('#layericon'+$('#container').data('slice')).addClass('active');

        $('.layericon,.active img').attr('src', "../assets/icon_layer_selected.svg");

        event.preventDefault();
      });

      $('#container').draggable({ drag: dragUpdate});
    }

    client.on('open', function(){
      buildTiles();
      activateControls();
    });
  </script>

  <style>
    #viewport {
      margin-left: auto;
      margin-right: auto;
      overflow: hidden;       
      border-color: black;
      border-width: 4pt;
      border-style: solid;
      width: 1024px;
      height: 1024px;      
    }

    .hidden {
      display: none;
    }

    #container {
      position:relative;
      overflow: hidden;
      top: 300px;
      left: 0px;
      width: 4096px;
      height: 4096px;
    }
    .tile {
      position: absolute;
      overflow: hidden;
      width: 256px;
      height: 256px;
    }

    #info td {
      font-size: 20pt;
    }
    .layericon {
      position:absolute;
      width:100px;
    }
  </style>  
</head>
<body>
  <div id="viewport">
  <div id="container" data-slice=1 data-zoom=0>
  </div>
  </div>
  <div id="info">
    <table>
      <tr><td>Slice:</td><td id="slice">1</td><td>/168</td></tr>
      <tr><td>Zoom:</td><td id="zoom">1</td></tr>
    </table>
  </div>
</body>
</html>