<html>
<head>
  <script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
  <link rel="stylesheet" href="http://code.jquery.com/ui/1.11.0/themes/smoothness/jquery-ui.css">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="./assets/viewer.css" rel="stylesheet">

    <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css">



  <script src="//code.jquery.com/ui/1.11.0/jquery-ui.js"></script>
  <script src="http://cdn.binaryjs.com/0/binary.js"></script>
  <script src="./assets/jquery.mousewheel.min.js"></script>
  <script src="./assets/sprintf.min.js"></script>
  <script src="./assets/purl.min.js"></script>
  <script src="./config.js"></script>
  <script>
    // Connect to Binary.js server
    var client;
    var controlStream;

    var info;
    var TILESIZE = 256;
    var VIEWPORTW = $(window).width();
    var VIEWPORTH = $(window).height();

    var rmb = false;
    var stack_opened = false;
    var tiles_loading = 0;
    var highResLoaded = false;
    //var streams = {};

    function openStack() {
      var url = $.url();
      var uuid = url.param('id');
      controlStream.write({'action':'open', 'uuid':uuid});
      stack_opened = true;
    } 

    function loadImage(target, src) {
//      controlStream.write({'action':'send', 'path':src});
      controlStream.write({'action':'send', 'path':src, 'target':target});
      tiles_loading += 1;
    }

    function buildTiles() {
      $('.tile').remove();

      var nx = info['tile sets'][$('#container').data('zoom')]['nx'];
      var ny = info['tile sets'][$('#container').data('zoom')]['ny'];

      for (x=0; x<nx; x++) {
        for (y=0; y<ny; y++) {
          tile = $('<div class="tile"><img src=""/></div>');
          tile.data('x', x);
          tile.data('y', y);
          tile.attr('id', 'tile_'+x+'_'+y)
          tile.addClass('hidden');
          $('#container').append(tile);
        }
      }

      $('.tile').each( function () {
        $(this).css('left', $(this).data('x')*256);
        $(this).css('top', $(this).data('y')*256);
      });
    }

    function buildViewer(slice, zoom) {
      el = $('<div id="container" data-slice=1 data-zoom=0></div>');
      el.data('zoom', zoom);
      el.data('slice',slice);
      $('#viewport').prepend(el);
      var nx = info['tile sets'][zoom]['nx'];
      var ny = info['tile sets'][zoom]['ny'];
      $('#container').css('width', nx*TILESIZE);
      $('#container').css('height', ny*TILESIZE);

      $('#viewport').css('width', VIEWPORTW);
      $('#viewport').css('height', VIEWPORTH);

      return el;      
    }

    function goHome() {
      console.log('going home');
      changeZoom(info['tile sets'].length-1,false);
      changeLayer(parseInt(info['number of slices']/2));    
      var el = $('#container');
      console.log('changing pos');
      el.css('left', parseInt(el.css('width'))/2);
      el.css('top', parseInt(el.css('height'))/2);
    }

    function buildInfo() {
      for (i=info['number of slices']-1; i>=0; i--) {
        tile = $('<div class="layericon"><img src="./assets/icon_layer.svg"/></div>');
        tile.attr('id', 'layericon'+i);
        tile.css('top', 100+800*i/info['number of slices']);
        $('#info').append(tile);      
      }      
    }

    function preloadBordering() {
      if (!highResLoaded) return;
      var x0 = parseInt($('#container').css('left'));
      var y0 = parseInt($('#container').css('top'));
      $('.tile').each( function () {
        var x = x0 + parseInt($(this).css('left'));
        var y = y0 + parseInt($(this).css('top'));
        if (x > 0-TILESIZE*4 && y > 0-TILESIZE*4 && x < VIEWPORTW+TILESIZE*3 && y < VIEWPORTH+TILESIZE*3) {
          if ($('img', this).attr('src') == '') {
            loadImage($(this).attr('id'), sprintf("/zoom%1d/slice_%04d/tile_x%04d_y%04d.20.jpg", 
            $('#container').data('zoom'), $('#container').data('slice'), $(this).data('x'), $(this).data('y')));
          }
        }
      });
    }

    function updateVisibleTiles() {     
      var x0 = -parseInt($('#container').css('left'));
      var y0 = -parseInt($('#container').css('top'));

      var nxmin = Math.max(0, Math.floor(x0/TILESIZE)-1);
      var nymin = Math.max(0, Math.floor(y0/TILESIZE)-1);
      var nxmax = Math.min(info['tile sets'][$('#container').data('zoom')]['nx'], Math.ceil(x0/TILESIZE+VIEWPORTW/TILESIZE)+1);
      var nymax = Math.min(info['tile sets'][$('#container').data('zoom')]['ny'], Math.ceil(y0/TILESIZE+VIEWPORTH/TILESIZE)+1);
      console.log(nxmin, nxmax);
      //console.log(nxmax);
      //console.log(nymin);
      //console.log(nymax);
      $('.tile').each( function () {
        var nx = $(this).data('x');
        var ny = $(this).data('y');
        if (nx < nxmin || nx > nxmax || ny < nymin || ny > nymax) {
          $(this).remove();
        }
      });

      for (var i=nxmin; i<=nxmax; i++) {
        for (var j=nymin; j<=nymax; j++) {
          if ($('div.tile#tile_'+i+'_'+j).length != 1) {
            tile = $('<div class="tile"><img src=""/></div>');
            tile.data('x', i);
            tile.data('y', j);
            tile.attr('id', 'tile_'+i+'_'+j)
            //tile.addClass('hidden');
            tile.css('left', tile.data('x')*256);
            tile.css('top', tile.data('y')*256);          
            $('#container').append(tile);
            loadImage(tile.attr('id'), sprintf("/zoom%1d/slice_%04d/tile_x%04d_y%04d.20.jpg", 
                      $('#container').data('zoom'), $('#container').data('slice'), tile.data('x'), tile.data('y')));                        
          }
        }
      }
    }

    function dragUpdate(event, ui) {
      updateVisibleTiles();
      //preloadBordering();     
    }

    function updateInfo() {
      $('#info #slice').text(sprintf("Slice %d of %d", $('#container').data('slice')+1, info['number of slices']));
      var scale = Math.pow(2, $('#container').data('zoom'));
      $('#info #zoom').text(sprintf("Scale 1 : %d", scale));

      $('.layericon,.active img').attr('src', "./assets/icon_layer.svg");
      $('.layericon,.active').removeClass('active');
      $('#layericon'+$('#container').data('slice')).addClass('active');

      $('.layericon,.active img').attr('src', "./assets/icon_layer_selected.svg");           
    }

    function updateTileImages() {
      updateVisibleTiles();
//      highResLoaded = false;
//      $('.tile:not(.hidden)').each( function () {
//        loadImage($(this).attr('id'), sprintf("/zoom%1d/slice_%04d/tile_x%04d_y%04d.20.jpg", 
//          $('#container').data('zoom'), $('#container').data('slice'), $(this).data('x'), $(this).data('y')));
//      });
    }

    function loadHighresTileImages() {
      $('.tile:not(.highres)').each( function () {
        loadImage($(this).attr('id'), sprintf("/zoom%1d/slice_%04d/tile_x%04d_y%04d.80.jpg", 
          $('#container').data('zoom'), $('#container').data('slice'), $(this).data('x'), $(this).data('y')));
        $(this).addClass('highres');
      });
    }

    function setLocation(layer, zoom, centerX, centerY) {
      el = $('#container');

      if (zoom<0) { zoom=0; }
      if (zoom>info['tile sets'].length-1) { zoom = info['tile sets'].length-1; }


      el.data('zoom',zoom);

      var nx = info['tile sets'][$('#container').data('zoom')]['nx'];
      var ny = info['tile sets'][$('#container').data('zoom')]['ny'];
      $('#container').css('width', nx*TILESIZE);
      $('#container').css('height', ny*TILESIZE);      

      var x = centerX/Math.pow(2, zoom);
      x = $(window).width()/2 - x;
      var y = centerY/Math.pow(2, zoom);
      y = $(window).height()/2 - y;
      el.css('left', x);
      el.css('top', y);

      el.children('.tile').remove();

      if (layer<0) { layer=0; }
      if (layer>info['number of slices']-1) { layer = info['number of slices']-1; }
      el.data('slice', layer);

      updateTileImages();
      updateInfo();      
    }

    function changeZoom(zoom, event) {
      el = $('#container');
      oldzoom = el.data('zoom');

      if (zoom<0) { zoom=0; }
      if (zoom>info['tile sets'].length-1) { zoom = info['tile sets'].length-1; }

      if (zoom == oldzoom) return;
      
      var parentOffset = $('#viewport').offset(); 
   //or $(this).offset(); if you really just want the current element's offset
      if (event == false) {
        var mouseX = 0;
        var mouseY = 0;
      }
      else {
        var mouseX = event.pageX - parentOffset.left;
        var mouseY = event.pageY - parentOffset.top;
      }
      oldContainerX = parseInt(el.css('left'));
      oldContainerY = parseInt(el.css('top'));      
      newContainerX = mouseX - (mouseX - oldContainerX) * Math.pow(2, oldzoom-zoom);
      newContainerY = mouseY - (mouseY - oldContainerY) * Math.pow(2, oldzoom-zoom);

      oldContainer = el.clone();
      oldContainer.attr('id','').addClass('oldcontainer').prependTo('#viewport');
      oldContainer.children('.tile').attr('id','');

      el.data('zoom',zoom);
      el.css('left', newContainerX);
      el.css('top', newContainerY);

      var nx = info['tile sets'][$('#container').data('zoom')]['nx'];
      var ny = info['tile sets'][$('#container').data('zoom')]['ny'];
      $('#container').css('width', nx*TILESIZE);
      $('#container').css('height', ny*TILESIZE);      

      //buildTiles();     
      el.children('.tile').remove();
      updateTileImages();
      updateInfo();      
    }

    function changeLayer(i) {
      el = $('#container');
      if (i<0) { i=0; }
      if (i>info['number of slices']-1) { i = info['number of slices']-1; }
      el.data('slice', i);

      el.children('.tile').each( function () {
        $(this).removeClass('highres');
        loadImage($(this).attr('id'), sprintf("/zoom%1d/slice_%04d/tile_x%04d_y%04d.20.jpg", 
        $('#container').data('zoom'), $('#container').data('slice'), $(this).data('x'), $(this).data('y')));           
      });
      updateVisibleTiles();
      //updateTileImages();
      updateInfo();
      //console.log(event.deltaX, event.deltaY, event.deltaFactor);
    }

    function toggleInfo() {
      $('.overlay').toggleClass('hidden');
    }

    function toggleFlagBar() {
      if ($('#flagbar').hasClass('inactive')) {
        loadFlagBar();
      }
      $('#flagbar').toggleClass('inactive');
    }

    function saveSnapshot() {
      var x0, x1, y0, y1;
      x0 = -$('#container').offset().left;
      x1 = x0+$(window).width();
      y0 = -$('#container').offset().top;
      y1 = y0+$(window).height();
      var url = sprintf('/export/snapshot/%s/%d/%d/%d/%d/%d/%d', info['uuid'], $('#container').data('slice'), $('#container').data('zoom'), x0, y0, x1, y1);
      console.log(url);
      $('a#snapshotbutton').attr('href',url).attr('download','snapshot.png');
    }

    function saveFlag() {
      var x = $(window).width()/2-$('#container').offset().left;
      x = x*Math.pow(2, $('#container').data('zoom'));
      var y = $(window).height()/2-$('#container').offset().top;
      y = y*Math.pow(2, $('#container').data('zoom'));
      console.log(x, y);
      var data = JSON.stringify({"pixel_x":x,
              "pixel_y":y,
              "layer":$('#container').data('slice'),
              "stack":"/api/v1/stack/"+info.id+'/',
              "zoom":$('#container').data('zoom'),
              });

      $.ajax ({
                url: '/api/v1/flag/?format=json',
                type: "POST",
                data: data,
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                complete: loadFlagBar,
              }
      );
    }    

    function loadFlagBar() {
      console.log('loading flags');
      $('#flaglist').load('/flags/list/'+info.id+'/', function() {
        $('.flag_delete a').click( function() {
          $.get(this.target, function() {
            loadFlagBar();
          });
        });
        $('.flag_link a').click( function() {
          gotoFlag(this.target);
        });

      });
    }

    function gotoFlag(flagid) {
      var url = sprintf('http://test.stackstreamer.com/api/v1/flag/%s/?format=json', flagid);
      $.getJSON(url, function(flag) {
        setLocation(parseInt(flag.layer), parseInt(flag.zoom), parseInt(flag.pixel_x), parseInt(flag.pixel_y));
      });
    }

    function activateControls() {
      $('#container').mousewheel(function(event) {
        var delta = event.deltaY;
        if (delta > 1) { delta = 1; }
        if (delta < -1) { delta = -1; }

        if (rmb == true) {
          var i = $(this).data('zoom')+delta;
          changeZoom(i, event);
        }
        else {
  //        if (tiles_loading > 0) return;
          var i = $(this).data('slice')+delta;
          changeLayer(i);
        }
        event.preventDefault();
      });

      $('#container').mouseup(function(event) {
        if (event.originalEvent.detail === 2) { 
          if (event.which === 3) { // right-click
            var i = $(this).data('zoom')+1;
            changeZoom(i, event);
          } 
          if (event.which === 1) { // right-click
            var i = $(this).data('zoom')-1;
            changeZoom(i, event);
          } 
        }
      });

      $('#container').draggable({ drag: dragUpdate});

      $('#flagbutton').click(toggleFlagBar);
      $('#addflagbutton').click(saveFlag);
      $('#snapshotbutton').click(saveSnapshot);
        //$('a#snapshotbutton').attr('href','/export/fullslice/7a6e377e-ba80-4756-a857-a23c177722e2/100').attr('download','snapshot.png');

      $('#homebutton').click(goHome);
      $('#hideinfobutton').click(toggleInfo);

      $(document).keyup(function(e) {
        if (e.keyCode == 27) { 
          toggleInfo();
        }
      });
    }

    function connectToServer() {
      client = new BinaryClient(SERVER_ADDRESS);
      client.on('close', function() {
        console.log('Websocket connection closed, reopening');
        connectToServer();
      });

      client.on('open', function(){
        controlStream = client.createStream();
        if (stack_opened == false) openStack(); 
      });

      client.on('stream', function(stream, meta){
        if (meta['type'] == 'image') {    
          // Buffer for parts
          var parts = [];
          // Got new data
          stream.on('data', function(data){
            parts.push(data);
          });
          stream.on('end', function(){
            // Display new data in browser!
            $('#'+meta['target']+' img').attr('src', (window.URL || window.webkitURL).createObjectURL(new Blob(parts)));
            tiles_loading -= 1;
            if (tiles_loading == 0) {
              $('.oldcontainer').remove();
              //changeLayer(($('#container').data('slice')+1)%100);
              loadHighresTileImages();
            }
            stream.destroy();
          });
        }
        if (meta['type'] == 'info') {
          stream.on('data', function(data){         
            console.log('received info');
            info = $.parseJSON(data);

            var url = sprintf('/api/v1/stack/?uuid=%s', info['uuid']);
            $.getJSON( url, function( data ) { 
              info.id = data.objects[0].id;
            });

            updateInfo();
            //buildTiles();         
            buildInfo();
            buildViewer(parseInt(info['number of slices'])/2, info['tile sets'].length-1);
            goHome();
            activateControls();       
          });
        }
      });

    }

    connectToServer();
  </script>
<script type="text/javascript" language="javascript">
        $(function() {
            $(this).bind("contextmenu", function(e) {
                e.preventDefault();
            });
        }); 
    </script>
</head>
<body>
  <div id="viewport">

  <div id="info" class="info overlay">
    <table>
      <tr><td id="slice"></td></tr>
      <tr><td id="zoom"></td></tr>
    </table>
  </div>
  <div class="buttonbar overlay">
    <a id="questionbutton" class="disabledbutton">
      <span class="fa-stack fa-2x fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-question fa-inverse fa-stack-1x"></i>
      </span>
    </a>
    <a id="homebutton">
      <span class="fa-stack fa-2x fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-home fa-inverse fa-stack-1x"></i>
      </span>
    </a>
    <a id="arrowbutton" class="disabledbutton">
      <span class="fa-stack fa-2x fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-location-arrow fa-inverse fa-stack-1x"></i>
      </span>
    </a>
    <a id="flagbutton">
      <span class="fa-stack fa-2x fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-flag fa-inverse fa-stack-1x"></i>
      </span>
    </a>
    <a id="snapshotbutton">
      <span class="fa-stack fa-2x fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-camera fa-inverse fa-stack-1x"></i>
      </span>
    </a>
    <a id="exportbutton" class="disabledbutton">
      <span class="fa-stack fa-2x fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-download fa-inverse fa-stack-1x"></i>
      </span>
    </a>
    <a id="hideinfobutton">
      <span class="fa-stack fa-2x fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-arrows-alt fa-inverse fa-stack-1x"></i>
      </span>
    </a>    
  </div> 
  </div>  
  <div id="flagbar" class="flagbar inactive overlay">
    <div class="addflagbutton">
    <a id="addflagbutton">
      <span class="fa-stack fa-2x fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-plus fa-inverse fa-stack-1x"></i>
      </span>
    </a>    
    </div>
    <div id="flaglist"></div>
  </div>

</body>
</html>
